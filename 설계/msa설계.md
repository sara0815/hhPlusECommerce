# 어플리케이션 서버와 DB를 도메인별로 분리하는 경우 설계

msa구조로 어플리케이션 서버와 DB를 도메인별로 분리하는 경우 도메인 간 DB가 다르기 때문에 트랜잭션을 적용하지 못하게 된다.
이를 해결하기 위해 SAGA 패턴을 사용할 수 있다. 

## SAGA 패턴
SAGA 패턴이란 마이크로서비스들끼리 이벤트를 주고 받아 특정 작업이 실패하면 이전의 완료된 작업을 되돌려주는 보상 이벤트를 소싱함으로써 분산 환경에서의 원자성을 보장하는 패턴이다.
SAGA 패턴은 트랜잭션의 관리 주체가 DBMS가 아닌 Application에 있다. SAGA 패턴은 Choreography, Orchestration 2가지 패턴이 있다.

### Orchestration 패턴
중앙 집중형 패턴으로 중앙에 Orchestrator가 존재하여 모든 로컬 트랜잭션의 순서를 지휘한다. 
각 서비스에 명령(command) 메시지를 보내고, 서비스는 작업 완료 후 응답 이벤트를 오케스트레이터에 보낸다. 
그러면 오케스트레이터는 다음 명령 메시지를 서비스에 보내고 그러한 과정이 모여 하나의 기능이 된다.

### Choreography 패턴
각 서비스에서 작업 후 이벤트를 발행한다. 
다음 작업이 필요한 서비스의 이벤트 핸들러는 해당 이벤트를 구독하여 다음 작업을 진행한다.
다음 작업이 완료되면 또 다른 이벤트를 발행하고 그러한 과정이 모여 하나의 기능이 된다.

### Orchestration 패턴 적용
주문의 경우 회원, 쿠폰, 상품, 주문, 포인트 등 여러 도메인을 거치게 되므로 Orchestration을 적용하는 것이 적합할 것같다.
Kafka를 이용하여 어떤 이벤트가 호출되고 어떤 보상 트랜잭션이 성공하고 실패했는지를 기록한다.
주문 번호를 transaction key로 저장하여 중복 처리가 되지 않도록 한다.
보상 트랜잭션이 실패하는 경우 3회까지 재시도 로직을 실행한다.
3회 재시도까지 실패하는 경우 관리자에 알림을 보낸다.
